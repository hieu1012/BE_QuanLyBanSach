# JWT Token & Session Management Documentation

## Tổng Quan

Ứng dụng sử dụng **JWT (JSON Web Token)** để quản lý authentication và authorization. **KHÔNG có lưu session trên server** - đây là stateless authentication.

## 1. Token Generation (Tạo Token)

### Tất Cả Tài Khoản Có Token
✅ **MASTER account** - Tự động tạo khi app khởi động
✅ **ADMIN accounts** - Có token khi login
✅ **USER accounts** - Có token khi login

### Khi Nào Token Được Tạo?
Token được tạo **KHI LOGIN** thành công. Bất kỳ tài khoản nào (master, admin, hoặc user) đều sẽ nhận được token.

### Request Login
```bash
POST http://localhost:8081/api/auth/login
Content-Type: application/json

{
  "username": "master",
  "password": "1111"
}
```

### Response Login
```json
{
  "status": 200,
  "message": "Đăng nhập thành công",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "user": {
      "id": 1,
      "username": "master",
      "email": "master@bookstore.com",
      "fullName": "Master Administrator",
      "role": "MASTER"
    }
  }
}
```

## 2. Token Configuration

### Token Type
- **Algorithm**: HS256 (HMAC-SHA256)
- **Format**: JWT (JSON Web Token)
- **Secret Key**: Được lưu trong `application.properties`

### Token Expiration
```properties
# Access Token: 24 hours (86400000 ms)
jwt.expiration=86400000

# Refresh Token: 7 days (604800000 ms)  
jwt.refresh-expiration=604800000
```

### JWT Secret
```properties
jwt.secret=MySecretKeyForJWTTokenGenerationAndValidationPurposesOnlyDontChangeThisKey1234567890!@#$%^&*()
```

## 3. Token Usage (Sử Dụng Token)

### Thêm Token vào Request
Tất cả các API request (ngoại trừ login, register) phải thêm `Authorization` header:

```bash
Authorization: Bearer <access_token>
```

### Ví Dụ Với cURL
```bash
curl -X GET http://localhost:8081/api/categories \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"
```

### Ví Dụ Với Postman
1. Đi tới tab **Authorization**
2. Chọn **Type**: `Bearer Token`
3. Dán **Token** vào field
4. Gửi request

## 4. Session Management

### Không Có Server-Side Session
❌ **KHÔNG lưu session trên server**
❌ **KHÔNG có session storage (database, cache, v.v.)**

### Stateless Authentication
- ✅ **Stateless**: Mỗi request là độc lập
- ✅ **Secure**: Token được ký bằng secret key
- ✅ **Scalable**: Không cần session storage, dễ mở rộng
- ✅ **Flexible**: Client có thể giữ token và gửi đi bất kỳ lúc nào

### Token Validation Flow
```
Client Request với Token
    ↓
JwtAuthenticationFilter
    ↓
Xác thực token (kiểm tra signature, expiration)
    ↓
Extract user info từ token (username, userId, role)
    ↓
Tạo Authentication object
    ↓
Đặt vào SecurityContext
    ↓
Xử lý request
```

## 5. Token Claims (Dữ Liệu Trong Token)

Token chứa thông tin sau:
```json
{
  "sub": "username",           // Subject (username)
  "userId": 1,                 // User ID
  "role": "MASTER",            // User role
  "iat": 1700000000,          // Issued at (thời gian tạo)
  "exp": 1700086400           // Expiration (thời gian hết hạn)
}
```

## 6. Token Lifecycle

### Tạo Token
1. User login dengan username & password
2. Server xác thực credentials
3. Server tạo JWT token
4. Return token cho client

### Sử Dụng Token
1. Client lưu token (localStorage, sessionStorage, cookie)
2. Client gửi token trong Authorization header
3. Server xác thực token
4. Server process request

### Refresh Token
Khi access token hết hạn, dùng refresh token để lấy access token mới:

```bash
POST http://localhost:8081/api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Logout
Token không bị delete trên server. Client chỉ cần xóa token ở phía mình (xóa khỏi localStorage, sessionStorage, cookie).

## 7. Security Features

### 1. Token Signature Verification
- Token được ký bằng secret key
- Bất kỳ thay đổi nào trong token sẽ làm invalid signature
- Server verify signature trước khi accept token

### 2. Token Expiration
- Access token hết hạn sau 24 giờ
- Refresh token hết hạn sau 7 ngày
- Server kiểm tra expiration time trước mỗi request

### 3. Role-Based Access Control (RBAC)
```java
@PreAuthorize("hasRole('ADMIN')")
@GetMapping("/admin-only")
public ResponseEntity<?> adminOnly() {
    // Chỉ ADMIN có thể access
}
```

## 8. Token Storage Client-Side

### Tùy Chọn 1: localStorage
```javascript
// Lưu token
localStorage.setItem('accessToken', token);
localStorage.setItem('refreshToken', refreshToken);

// Lấy token
const token = localStorage.getItem('accessToken');

// Xóa token (logout)
localStorage.removeItem('accessToken');
localStorage.removeItem('refreshToken');
```

### Tùy Chọn 2: sessionStorage
```javascript
sessionStorage.setItem('accessToken', token);
// Tự động xóa khi đóng browser tab
```

### Tùy Chọn 3: HttpOnly Cookie
```javascript
// Server set cookie (HttpOnly, Secure)
Set-Cookie: accessToken=...; HttpOnly; Secure; SameSite=Strict
// Client không thể access qua JavaScript
```

## 9. Tài Khoản Test

### Master Account
| Thuộc Tính | Giá Trị |
|-----------|--------|
| Username | master |
| Password | 1111 |
| Email | master@bookstore.com |
| Role | MASTER |
| Token | Có (khi login) |

### Admin Accounts
| Username | Email | Password | Role | Token |
|----------|-------|----------|------|-------|
| admin01 | admin01@bookstore.com | 1111 | ADMIN | Có |
| admin02 | admin02@bookstore.com | 1111 | ADMIN | Có |

### User Accounts
| Username | Email | Password | Role | Token |
|----------|-------|----------|------|-------|
| customer01 | customer01@gmail.com | 1111 | USER | Có |
| customer02 | customer02@gmail.com | 1111 | USER | Có |
| ... | ... | 1111 | USER | Có |
| customer10 | customer10@gmail.com | 1111 | USER | Có |

**Tất cả tài khoản đều có token khi login thành công!**

## 10. API Endpoints Auth

### Login
```
POST /api/auth/login
Body: { "username": "...", "password": "..." }
Response: { "accessToken": "...", "refreshToken": "...", "user": {...} }
```

### Refresh Token
```
POST /api/auth/refresh
Body: { "refreshToken": "..." }
Response: { "accessToken": "..." }
```

### Get Current User
```
GET /api/auth/me
Header: Authorization: Bearer <token>
Response: { "id": 1, "username": "...", "role": "..." }
```

## 11. Exception Handling

### Token Invalid
```json
{
  "status": 401,
  "message": "Invalid token",
  "error": "UNAUTHORIZED"
}
```

### Token Expired
```json
{
  "status": 401,
  "message": "Token expired",
  "error": "TOKEN_EXPIRED"
}
```

### Missing Authorization Header
```json
{
  "status": 401,
  "message": "Missing or invalid Authorization header",
  "error": "UNAUTHORIZED"
}
```

## 12. Best Practices

### Security
1. ✅ **Luôn sử dụng HTTPS** trong production
2. ✅ **Không lưu token trong URL** (query parameter)
3. ✅ **Sử dụng HttpOnly Cookie** nếu có thể
4. ✅ **Implement token refresh** trước khi token hết hạn
5. ✅ **Verify token signature** trên mỗi request

### Client-Side
1. ✅ **Lưu token sau login**
2. ✅ **Gửi token trong Authorization header**
3. ✅ **Handle token expiration**
4. ✅ **Implement auto refresh**
5. ✅ **Xóa token khi logout**

### Server-Side
1. ✅ **Verify token signature**
2. ✅ **Check token expiration**
3. ✅ **Extract user info từ token**
4. ✅ **Implement role-based access**
5. ✅ **Log authentication events**

## 13. Troubleshooting

### Q: Token không hoạt động?
A: Kiểm tra:
- ✓ Token chưa hết hạn
- ✓ Token được gửi trong Authorization header
- ✓ Format đúng: `Bearer <token>`
- ✓ Secret key giống nhau

### Q: Unauthorized 401?
A: Nguyên nhân:
- ❌ Missing Authorization header
- ❌ Invalid token format
- ❌ Token hết hạn
- ❌ Token bị thay đổi

### Q: Làm sao để logout?
A: Xóa token ở client:
- localStorage.removeItem('accessToken')
- sessionStorage.removeItem('accessToken')
- Xóa cookie

---
**Note**: Đây là stateless authentication không có session storage trên server.
